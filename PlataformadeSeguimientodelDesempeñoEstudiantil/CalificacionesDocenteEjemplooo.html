<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calificaciones Docente - CMT</title>
        <link rel="stylesheet" href="calificacionesDocente.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <a href="index.html" class="logo">CMT</a>
        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="InicioSesionDocente.html">Cerrar Sesión</a></li>
            </ul>
        </nav>
    </header>
    
    <section class="grades-section">
        <div class="grades-header">
            <h1 class="grades-title">Calificaciones</h1>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="export-btn">
                    <i class="fas fa-file-export"></i>
                    Exportar PDF
                </button>
            </div>
        </div>
        
        <div class="filters">
            <div class="select-container">
                <label for="semester-select" class="select-label">Semestre:</label>
                <select id="semester-select" class="select-input">
                    <option value="">Seleccionar semestre</option>
                    <option value="1" selected>Primer Semestre</option>
                    <option value="2">Tercer Semestre</option>
                    <option value="3">Quinto Semestre</option>
                    <option value="4"> Septimo Semestre</option>
                </select>
            </div>
            
            <div class="select-container">
                <label for="course-select" class="select-label">Curso:</label>
                <select id="course-select" class="select-input">
                    <option value="">Seleccionar curso</option>
                    <option value="1" selected>Lenguajes de interfaz 6C</option>
                    <option value="2">Programación de base de datos</option>
                    <option value="3">Graficación</option>
                    <option value="4">Lenguajes automatas I</option>
                    <option value="5">Taller de investigación</option>
                </select>
            </div>
            
            <div class="select-container">
                <label for="status-select" class="select-label">Estado:</label>
                <select id="status-select" class="select-input">
                    <option value="all" selected>Todos</option>
                    <option value="passed">Aprobados</option>
                    <option value="failed">Reprobados</option>
                </select>
            </div>
        </div>
        
        <table class="grades-table">
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>Unidad 1</th>
                    <th>Unidad 2</th>
                    <th>Unidad 3</th>
                    <th>Promedio</th>
                    <th>Comentario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="grades-body">
                <?php
                $sql = "SELECT * FROM estudiantes";
                $result = $conn->query($sql);
    
                while($row = $result->fetch_assoc()):
                    function colorClass($nota) {
                        if (is_null($nota)) return '';
                        return $nota >= 70 ? 'green' : 'red';
                    }
                ?>
                <tr>
                    <td><?= $row['nombre'] ?></td>
                <td class="<?= colorClass($row['unidad1']) ?>"><?= $row['unidad1'] ?? '—' ?></td>
                <td class="<?= colorClass($row['unidad2']) ?>"><?= $row['unidad2'] ?? '—' ?></td>
                <td class="<?= colorClass($row['unidad3']) ?>"><?= $row['unidad3'] ?? '—' ?></td>
                <td class="<?= colorClass($row['promedio']) ?>"><?= $row['promedio'] ?></td>
                <td><?= $row['comentario'] ?></td>
                    <td class="action-cell">
                        <button class="edit-comment-btn" data-student-id="1" title="Agregar comentario">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="edit-grade-btn" data-student-id="1" title="Modificar calificación">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
                <?php endwhile; ?>
            </tbody>
        </table>
    </section>
    
    <!-- Modal para agregar comentario -->
    <div class="modal" id="comment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar comentario para <span id="student-name"></span></h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="comment-form">
                <input type="hidden" id="student-id" value="">
                <div class="form-group">
                    <label for="comment" class="form-label">Comentario:</label>
                    <textarea id="comment" class="form-input" rows="4"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para modificar calificación -->
    <div class="modal" id="grade-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modificar calificación para <span id="grade-student-name"></span></h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="grade-form">
                <input type="hidden" id="grade-student-id" value="">
                <div class="form-group">
                    <label for="unit-select" class="form-label">Unidad:</label>
                    <select id="unit-select" class="form-input">
                        <option value="1">Unidad 1</option>
                        <option value="2">Unidad 2</option>
                        <option value="3">Unidad 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-grade" class="form-label">Nueva calificación (0-100):</label>
                    <input type="number" id="new-grade" class="form-input" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label for="grade-comment" class="form-label">Comentario (opcional):</label>
                    <textarea id="grade-comment" class="form-input" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <footer>
        <div class="copyright">
            &copy; 2023 CMT. Todos los derechos reservados.
        </div>
    </footer>
    
    <script>
       
        
        // Función para renderizar la tabla de calificaciones
        function renderGradesTable(data) {
            const gradesBody = document.getElementById('grades-body');
            gradesBody.innerHTML = '';
            
            if (data.length === 0) {
                gradesBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-message">
                            No se encontraron estudiantes con ese filtro
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(student => {
                const unit1Class = getGradeClass(student.unit1);
                const unit2Class = getGradeClass(student.unit2);
                const unit3Class = getGradeClass(student.unit3);
                const avgClass = getGradeClass(student.average);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td><span class="grade-cell ${unit1Class}">${student.unit1}</span></td>
                    <td><span class="grade-cell ${unit2Class}">${student.unit2}</span></td>
                    <td><span class="grade-cell ${unit3Class}">${student.unit3}</span></td>
                    <td><span class="grade-cell ${avgClass}">${student.average}</span></td>
                    <td class="comment-cell" title="${student.comment}">${student.comment}</td>
                    <td class="action-cell">
                        <button class="edit-comment-btn" data-student-id="${student.id}" title="Agregar comentario">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="edit-grade-btn" data-student-id="${student.id}" title="Modificar calificación">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                gradesBody.appendChild(row);
            });
            
            // Agregar event listeners para los botones de acción
            addActionListeners();
        }
        
        // Función para determinar la clase de la calificación
        function getGradeClass(score) {
            if (score >= 85) return 'grade-high';
            if (score >= 70) return 'grade-mid';
            return 'grade-low';
        }
        
        // Función para filtrar estudiantes por estado
        function filterStudents() {
            const statusFilter = document.getElementById('status-select').value;
            let filtered = [...studentsData];
            
            if (statusFilter === 'passed') {
                filtered = filtered.filter(student => student.average >= 70);
            } else if (statusFilter === 'failed') {
                filtered = filtered.filter(student => student.average < 70);
            }
            
            renderGradesTable(filtered);
        }
        
        // Event listener para el filtro de estado
        document.getElementById('status-select').addEventListener('change', filterStudents);
        
        // Función para agregar event listeners a los botones de acción
        function addActionListeners() {
            // Botones para comentarios
            document.querySelectorAll('.edit-comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    const student = studentsData.find(s => s.id === parseInt(studentId));
                    
                    document.getElementById('student-name').textContent = student.name;
                    document.getElementById('student-id').value = studentId;
                    document.getElementById('comment').value = student.comment;
                    
                    document.getElementById('comment-modal').style.display = 'flex';
                });
            });
            
            // Botones para calificaciones
            document.querySelectorAll('.edit-grade-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    const student = studentsData.find(s => s.id === parseInt(studentId));
                    
                    document.getElementById('grade-student-name').textContent = student.name;
                    document.getElementById('grade-student-id').value = studentId;
                    document.getElementById('new-grade').value = '';
                    document.getElementById('grade-comment').value = '';
                    
                    document.getElementById('grade-modal').style.display = 'flex';
                });
            });
        }
        
        // Event listeners para cerrar modales
        document.querySelectorAll('.close-btn, .close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('comment-modal').style.display = 'none';
                document.getElementById('grade-modal').style.display = 'none';
            });
        });
        
        // Event listener para el formulario de comentarios
        document.getElementById('comment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = parseInt(document.getElementById('student-id').value);
            const newComment = document.getElementById('comment').value;
            
            // Actualizar datos (en una aplicación real, esto sería una llamada a la API)
            const studentIndex = studentsData.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                studentsData[studentIndex].comment = newComment;
                
                // Actualizar la tabla
                filterStudents();
                
                // Cerrar modal
                document.getElementById('comment-modal').style.display = 'none';
                
                // Mostrar mensaje de éxito
                alert('Comentario actualizado correctamente');
            }
        });
        
        // Event listener para el formulario de calificaciones
        document.getElementById('grade-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = parseInt(document.getElementById('grade-student-id').value);
            const unit = document.getElementById('unit-select').value;
            const newGrade = parseInt(document.getElementById('new-grade').value);
            const comment = document.getElementById('grade-comment').value;
            
            if (newGrade < 0 || newGrade > 100) {
                alert('La calificación debe estar entre 0 y 100');
                return;
            }
            
            // Actualizar datos (en una aplicación real, esto sería una llamada a la API)
            const studentIndex = studentsData.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                const student = studentsData[studentIndex];
                
                // Actualizar calificación según la unidad
                if (unit === '1') student.unit1 = newGrade;
                else if (unit === '2') student.unit2 = newGrade;
                else if (unit === '3') student.unit3 = newGrade;
                
                // Recalcular promedio
                student.average = Math.round((student.unit1 + student.unit2 + student.unit3) / 3);
                
                // Actualizar comentario si se proporcionó
                if (comment) {
                    student.comment = comment;
                }
                
                // Actualizar la tabla
                filterStudents();
                
                // Cerrar modal
                document.getElementById('grade-modal').style.display = 'none';
                
                // Mostrar mensaje de éxito
                alert('Calificación actualizada correctamente');
            }
        });
        
        // Event listener para exportar a PDF
        document.getElementById('export-btn').addEventListener('click', function() {
            alert('Exportando calificaciones a PDF... (Esta funcionalidad se implementaría con una biblioteca como jsPDF)');
        });
        
        // Iniciar la aplicación renderizando los datos
        renderGradesTable(studentsData);
    </script>
</body>
</html>